<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERFA TEKNÄ°K</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .brand {
            background: #1a1a2e;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            letter-spacing: 3px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 60px);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        .header.worker { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .content { padding: 30px 20px; }
        .home-content { padding: 50px 30px; text-align: center; }
        .home-icon { font-size: 80px; margin-bottom: 30px; }
        h1 { font-size: 24px; margin-bottom: 8px; }
        h2 { font-size: 22px; margin-bottom: 40px; color: #333; }
        .btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-manager { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-worker { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .btn-primary { background: #667eea; }
        .btn-success { background: #2ecc71; }
        .btn-danger { background: #e74c3c; }
        .btn-excel { background: #217346; }
        .btn-back { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-refresh { background: #f39c12; }
        .btn-delete { background: #e74c3c; padding: 8px 12px; font-size: 13px; margin: 5px 0; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }
        .tabs { display: flex; background: #f5f5f5; }
        .tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
        }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .card { background: #f8f9fa; padding: 15px; margin: 12px 0; border-radius: 10px; border-left: 4px solid #667eea; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-value { font-size: 32px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.9; margin-top: 5px; }
        .alert { padding: 14px; margin: 15px 0; border-radius: 10px; text-align: center; font-weight: 600; }
        .alert-danger { background: #f8d7da; color: #721c24; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .alert-warning { background: #fff3cd; color: #856404; }
        .location-badge { 
            display: inline-block; 
            padding: 8px 14px; 
            background: #d4edda; 
            color: #155724; 
            border-radius: 8px; 
            font-size: 13px; 
            margin: 10px 0; 
        }
        .status-card { padding: 40px 30px; border-radius: 14px; text-align: center; margin: 20px 0; color: white; }
        .status-ready { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        h3 { margin: 25px 0 15px; color: #333; font-size: 18px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .settings-box { background: #fff3cd; padding: 15px; border-radius: 10px; margin: 20px 0; }
        .settings-box h4 { margin-bottom: 10px; color: #856404; }
    </style>
</head>
<body>
    <div class="brand">SERFA TEKNÄ°K</div>
    <div class="container">
        <div id="app"></div>
    </div>

    <script>
    var SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxpQws9sY4EAREhfD36qpBaCoBuRF_Z6IqN586LYRxhVPsJCX6TY5LZonMgdif6ijHq/exec';
        var ADMIN_PASSWORD = localStorage.getItem('adminPassword') || '1234';
        
        var APP = {
            workers: [],
            sites: [],
            records: [],
            currentWorker: JSON.parse(localStorage.getItem('currentWorker') || 'null'),
            location: null
        };

        function init() {
            getLocation();
            setInterval(getLocation, 30000);
            showHome();
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(pos) { 
                        APP.location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        console.log('GPS OK:', APP.location);
                    },
                    function(err) { 
                        APP.location = null;
                        console.log('GPS ERROR:', err);
                    },
                    { enableHighAccuracy: true }
                );
            }
        }

        function render(html) {
            document.getElementById('app').innerHTML = html;
        }

        function showLoading() {
            return '<div class="loading"><div class="spinner"></div><p>YÃ¼kleniyor...</p></div>';
        }

        async function loadData(sheet) {
            try {
                console.log('YÃ¼kleniyor:', sheet);
                var res = await fetch(SCRIPT_URL + '?sheet=' + sheet);
                var data = await res.json();
                console.log('YÃ¼klendi:', sheet, data);
                return data.data || [];
            } catch (e) {
                console.error('YÃ¼kleme hatasÄ±:', sheet, e);
                return [];
            }
        }

        async function saveData(sheet, values) {
            try {
                console.log('Kaydediliyor:', sheet, values);
                var res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ sheet: sheet, values: values })
                });
                var result = await res.json();
                console.log('Kaydedildi:', result);
                return result.success;
            } catch (e) {
                console.error('KayÄ±t hatasÄ±:', e);
                alert('âš ï¸ Veri kaydedilemedi. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
                return false;
            }
        }

        function showHome() {
            var html = '<div class="header"><h1>ğŸ—ï¸ Åantiye Takip Sistemi</h1><p>Profesyonel Ä°nÅŸaat YÃ¶netimi</p></div>';
            html += '<div class="home-content">';
            html += '<div class="home-icon">ğŸ—ï¸</div>';
            html += '<h2>HoÅŸ Geldiniz</h2>';
            html += '<button class="btn btn-manager" onclick="showManagerLogin()">ğŸ‘” Ä°ÅŸveren / YÃ¶netici</button>';
            html += '<button class="btn btn-worker" onclick="showWorkerLogin()">ğŸ‘· Ä°ÅŸÃ§i</button>';
            html += '</div>';
            render(html);
        }

        function showManagerLogin() {
            var html = '<div class="header"><h1>ğŸ‘” YÃ¶netici GiriÅŸi</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">â† Geri</button>';
            html += '<div style="text-align: center; padding: 40px 20px;">';
            html += '<div style="font-size: 60px; margin-bottom: 20px;">ğŸ”</div>';
            html += '<h2>Åifre Girin</h2>';
            html += '<div class="form-group"><input type="password" id="pass" placeholder="Åifre"></div>';
            html += '<button class="btn btn-primary" onclick="checkPass()">GiriÅŸ</button>';
            html += '</div></div>';
            render(html);
        }

        function checkPass() {
            if (document.getElementById('pass').value === ADMIN_PASSWORD) {
                showManagerPanel('add');
            } else {
                alert('âŒ HatalÄ± ÅŸifre!');
            }
        }

        async function showManagerPanel(tab) {
            render('<div class="header"><h1>ğŸ‘” YÃ¶netici Paneli</h1></div><div class="content">' + showLoading() + '</div>');
            
            var workersData = await loadData('workers');
            var sitesData = await loadData('sites');
            var recordsData = await loadData('records');
            
            APP.workers = [];
            APP.sites = [];
            APP.records = [];
            
            for (var i = 1; i < workersData.length; i++) {
                if (workersData[i] && workersData[i][0]) {
                    APP.workers.push({ 
                        id: workersData[i][0], 
                        name: workersData[i][1] || '', 
                        wage: workersData[i][2] || '',
                        password: workersData[i][3] || ''
                    });
                }
            }
            
            for (var i = 1; i < sitesData.length; i++) {
                if (sitesData[i] && sitesData[i][0]) {
                    APP.sites.push({ id: sitesData[i][0], name: sitesData[i][1] || '', addr: sitesData[i][2] || '' });
                }
            }
            
            for (var i = 1; i < recordsData.length; i++) {
                if (recordsData[i] && recordsData[i][0]) {
                    APP.records.push({
                        id: recordsData[i][0],
                        wid: recordsData[i][1] || '',
                        wname: recordsData[i][2] || '',
                        sid: recordsData[i][3] || '',
                        sname: recordsData[i][4] || '',
                        date: recordsData[i][5] || '',
                        time: recordsData[i][6] || '',
                        lat: recordsData[i][7] || '',
                        lng: recordsData[i][8] || ''
                    });
                }
            }
            
            var html = '<div class="header"><h1>ğŸ‘” YÃ¶netici Paneli</h1></div>';
            html += '<div class="tabs">';
            html += '<button class="tab ' + (tab === 'add' ? 'active' : '') + '" onclick="showManagerPanel(\'add\')">â• Ekle</button>';
            html += '<button class="tab ' + (tab === 'list' ? 'active' : '') + '" onclick="showManagerPanel(\'list\')">ğŸ“‹ Liste</button>';
            html += '<button class="tab ' + (tab === 'report' ? 'active' : '') + '" onclick="showManagerPanel(\'report\')">ğŸ“Š Rapor</button>';
            html += '<button class="tab ' + (tab === 'settings' ? 'active' : '') + '" onclick="showManagerPanel(\'settings\')">âš™ï¸ Ayarlar</button>';
            html += '</div><div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">â† Ã‡Ä±kÄ±ÅŸ</button>';

            if (tab === 'add') {
                html += '<h3>Ä°ÅŸÃ§i Ekle</h3>';
                html += '<div class="form-group"><label>Ad Soyad</label><input id="wn"></div>';
                html += '<div class="form-group"><label>GÃ¼nlÃ¼k Ãœcret (â‚º)</label><input type="number" id="ww"></div>';
                html += '<div class="form-group"><label>PIN Kodu (4 haneli)</label><input type="text" id="wp" placeholder="Ã¶rn: 5678" maxlength="4"></div>';
                html += '<button class="btn btn-primary" onclick="addWorker()">Ä°ÅŸÃ§i Ekle</button><hr style="margin: 30px 0;">';
                html += '<h3>Åantiye Ekle</h3>';
                html += '<div class="form-group"><label>Åantiye AdÄ±</label><input id="sn"></div>';
                html += '<div class="form-group"><label>Adres</label><input id="sa"></div>';
                html += '<button class="btn btn-primary" onclick="addSite()">Åantiye Ekle</button>';
            } else if (tab === 'list') {
                html += '<h3>Ä°ÅŸÃ§iler (' + APP.workers.length + ')</h3>';
                if (APP.workers.length === 0) html += '<div class="alert alert-info">HenÃ¼z iÅŸÃ§i eklenmemiÅŸ</div>';
                for (var i = 0; i < APP.workers.length; i++) {
                    html += '<div class="card"><b>' + APP.workers[i].name + '</b><br><small>ğŸ’° ' + APP.workers[i].wage + 'â‚º/gÃ¼n â€¢ ğŸ” PIN: ' + APP.workers[i].password + '</small></div>';
                }
                html += '<h3>Åantiyeler (' + APP.sites.length + ')</h3>';
                if (APP.sites.length === 0) html += '<div class="alert alert-info">HenÃ¼z ÅŸantiye eklenmemiÅŸ</div>';
                for (var i = 0; i < APP.sites.length; i++) {
                    html += '<div class="card"><b>' + APP.sites[i].name + '</b><br><small>ğŸ“ ' + APP.sites[i].addr + '</small></div>';
                }
                html += '<h3>KayÄ±tlar (' + APP.records.length + ')</h3>';
                if (APP.records.length === 0) html += '<div class="alert alert-info">HenÃ¼z kayÄ±t oluÅŸturulmamÄ±ÅŸ</div>';
                for (var i = APP.records.length - 1; i >= 0; i--) {
                    var r = APP.records[i];
                    html += '<div class="card"><b>' + r.wname + '</b><br>';
                    html += '<small>ğŸ—ï¸ ' + r.sname + ' â€¢ ğŸ“… ' + r.date + ' â€¢ â° ' + r.time + '</small><br>';
                    if (r.lat && r.lng) {
                        html += '<small>ğŸ“ Konum: ' + parseFloat(r.lat).toFixed(5) + ', ' + parseFloat(r.lng).toFixed(5) + '</small>';
                    }
                    html += '</div>';
                }
            } else if (tab === 'report') {
                html += '<button class="btn btn-excel" onclick="exportToExcel()">ğŸ“Š Excel Ä°ndir</button>';
                html += '<div class="stats">';
                html += '<div class="stat-box"><div class="stat-value">' + APP.records.length + '</div><div class="stat-label">TOPLAM KAYIT</div></div>';
                html += '<div class="stat-box"><div class="stat-value">' + APP.workers.length + '</div><div class="stat-label">AKTÄ°F Ä°ÅÃ‡Ä°</div></div>';
                html += '</div>';
                
                html += '<h3>Ä°ÅŸÃ§i BazlÄ± Rapor</h3>';
                var workerStats = {};
                for (var i = 0; i < APP.records.length; i++) {
                    var wid = APP.records[i].wid;
                    if (!workerStats[wid]) {
                        workerStats[wid] = { name: APP.records[i].wname, count: 0 };
                    }
                    workerStats[wid].count++;
                }
                for (var wid in workerStats) {
                    var ws = workerStats[wid];
                    html += '<div class="card"><b>' + ws.name + '</b><br><small>ğŸ“ ' + ws.count + ' kayÄ±t</small></div>';
                }
            } else if (tab === 'settings') {
                html += '<div class="settings-box">';
                html += '<h4>âš™ï¸ YÃ¶netici Åifresi DeÄŸiÅŸtir</h4>';
                html += '<div class="form-group"><label>Mevcut Åifre: <b>' + ADMIN_PASSWORD + '</b></label></div>';
                html += '<div class="form-group"><label>Yeni Åifre</label><input type="text" id="newpass"></div>';
                html += '<button class="btn btn-primary" onclick="changeAdminPassword()">Åifreyi DeÄŸiÅŸtir</button>';
                html += '</div>';
            }
            html += '</div>';
            render(html);
        }

        function changeAdminPassword() {
            var newPass = document.getElementById('newpass').value.trim();
            if (!newPass || newPass.length < 4) {
                alert('âŒ Åifre en az 4 karakter olmalÄ±!');
                return;
            }
            ADMIN_PASSWORD = newPass;
            localStorage.setItem('adminPassword', ADMIN_PASSWORD);
            alert('âœ… YÃ¶netici ÅŸifresi deÄŸiÅŸtirildi: ' + ADMIN_PASSWORD);
            showManagerPanel('settings');
        }

        async function addWorker() {
            var n = document.getElementById('wn').value.trim();
            var w = document.getElementById('ww').value.trim();
            var p = document.getElementById('wp').value.trim();
            if (!n || !w || !p) { alert('âŒ TÃ¼m alanlarÄ± doldurun!'); return; }
            if (p.length !== 4) { alert('âŒ PIN kodu 4 haneli olmalÄ±!'); return; }
            
            var id = Date.now().toString();
            var success = await saveData('workers', [[id, n, w, p]]);
            
            if (success) {
                alert('âœ… Ä°ÅŸÃ§i eklendi!\nAd: ' + n + '\nPIN: ' + p);
                showManagerPanel('add');
            }
        }

        async function addSite() {
            var n = document.getElementById('sn').value.trim();
            var a = document.getElementById('sa').value.trim();
            if (!n || !a) { alert('âŒ Eksik bilgi!'); return; }
            
            var id = Date.now().toString();
            var success = await saveData('sites', [[id, n, a]]);
            
            if (success) {
                alert('âœ… Åantiye eklendi!');
                showManagerPanel('add');
            }
        }

        function exportToExcel() {
            var csv = 'Ä°ÅŸÃ§i,Åantiye,Tarih,Saat,Enlem,Boylam\n';
            for (var i = 0; i < APP.records.length; i++) {
                var r = APP.records[i];
                csv += r.wname + ',' + r.sname + ',' + r.date + ',' + r.time + ',' + (r.lat || '') + ',' + (r.lng || '') + '\n';
            }
            var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'serfa-rapor-' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            alert('âœ… Excel dosyasÄ± indiriliyor!');
        }

        async function showWorkerLogin() {
            render('<div class="header worker"><h1>ğŸ‘· Ä°ÅŸÃ§i GiriÅŸi</h1></div><div class="content">' + showLoading() + '</div>');
            
            var workersData = await loadData('workers');
            APP.workers = [];
            
            for (var i = 1; i < workersData.length; i++) {
                if (workersData[i] && workersData[i][0]) {
                    APP.workers.push({ 
                        id: workersData[i][0], 
                        name: workersData[i][1] || '', 
                        wage: workersData[i][2] || '',
                        password: workersData[i][3] || ''
                    });
                }
            }
            
            if (APP.workers.length === 0) { 
                alert('âš ï¸ HenÃ¼z iÅŸÃ§i kaydÄ± yok!'); 
                showHome(); 
                return; 
            }
            
            var html = '<div class="header worker"><h1>ğŸ‘· Ä°ÅŸÃ§i GiriÅŸi</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">â† Geri</button>';
            html += '<div style="text-align: center; padding: 40px 20px;">';
            html += '<div style="font-size: 60px; margin-bottom: 20px;">ğŸ‘·</div>';
            html += '<h2>Ä°sminizi SeÃ§in</h2>';
            html += '<div class="form-group"><select id="ws"><option value="">SeÃ§in...</option>';
            for (var i = 0; i < APP.workers.length; i++) {
                html += '<option value="' + i + '">' + APP.workers[i].name + '</option>';
            }
            html += '</select></div>';
            html += '<div class="form-group"><label>PIN Kodunuz (4 haneli)</label><input type="password" id="wpass" maxlength="4" placeholder="****"></div>';
            html += '<button class="btn btn-success" onclick="loginWorker()">GiriÅŸ</button>';
            html += '</div></div>';
            render(html);
        }

        function loginWorker() {
            var idx = parseInt(document.getElementById('ws').value);
            var pass = document.getElementById('wpass').value.trim();
            
            if (isNaN(idx) || idx < 0) { 
                alert('âŒ Ä°ÅŸÃ§i seÃ§in!'); 
                return; 
            }
            
            if (!pass) {
                alert('âŒ PIN kodu girin!');
                return;
            }
            
            APP.currentWorker = APP.workers[idx];
            
            var correctPass = String(APP.currentWorker.password).trim();
            var enteredPass = String(pass).trim();
            
            console.log('Girilen PIN:', enteredPass);
            console.log('DoÄŸru PIN:', correctPass);
            console.log('EÅŸit mi?', correctPass === enteredPass);
            
            if (correctPass !== enteredPass) {
                alert('âŒ HatalÄ± PIN kodu!\nGirilen: ' + enteredPass + '\nBeklenen: ' + correctPass);
                return;
            }
            
            localStorage.setItem('currentWorker', JSON.stringify(APP.currentWorker));
            showWorkerPanel();
        }

        async function showWorkerPanel() {
            render('<div class="header worker"><h1>ğŸ‘· ' + APP.currentWorker.name + '</h1></div><div class="content">' + showLoading() + '</div>');
            
            var recordsData = await loadData('records');
            var sitesData = await loadData('sites');
            
            APP.records = [];
            APP.sites = [];
            
            for (var i = 1; i < recordsData.length; i++) {
                if (recordsData[i] && recordsData[i][0]) {
                    APP.records.push({
                        id: recordsData[i][0],
                        wid: recordsData[i][1] || '',
                        wname: recordsData[i][2] || '',
                        sid: recordsData[i][3] || '',
                        sname: recordsData[i][4] || '',
                        date: recordsData[i][5] || '',
                        time: recordsData[i][6] || '',
                        lat: recordsData[i][7] || '',
                        lng: recordsData[i][8] || ''
                    });
                }
            }
            
            for (var i = 1; i < sitesData.length; i++) {
                if (sitesData[i] && sitesData[i][0]) {
                    APP.sites.push({ id: sitesData[i][0], name: sitesData[i][1] || '', addr: sitesData[i][2] || '' });
                }
            }
            
            var myRecs = [];
            for (var i = 0; i < APP.records.length; i++) {
                if (APP.records[i].wid === APP.currentWorker.id) {
                    myRecs.push(APP.records[i]);
                }
            }

            var html = '<div class="header worker"><h1>ğŸ‘· ' + APP.currentWorker.name + '</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="logoutWorker()">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>';

            if (!APP.location) {
                html += '<div class="alert alert-danger">âš ï¸ GPS KAPALI!</div>';
                html += '<button class="btn btn-refresh" onclick="getLocation(); setTimeout(showWorkerPanel, 1000);">ğŸ”„ GPS Yenile</button>';
            } else {
                html += '<div class="location-badge">âœ… GPS Aktif</div>';
            }
            
            html += '<div class="status-card status-ready"><div style="font-size: 60px; margin-bottom: 15px;">ğŸŸ¢</div><h2>HazÄ±r</h2><p>Åantiye seÃ§in ve kaydedin</p></div>';
            
            if (APP.sites.length === 0) {
                html += '<div class="alert alert-warning">âš ï¸ HenÃ¼z ÅŸantiye eklenmemiÅŸ!</div>';
            } else {
                html += '<div class="form-group"><label>Åantiye SeÃ§</label><select id="wss"><option value="">SeÃ§in...</option>';
                for (var i = 0; i < APP.sites.length; i++) {
                    html += '<option value="' + i + '">' + APP.sites[i].name + '</option>';
                }
                html += '</select></div>';
                html += '<button class="btn btn-success" onclick="saveRecord();" ' + (!APP.location ? 'disabled' : '') + '>ğŸ’¾ Kaydet</button>';
            }
            
            html += '<h3>KayÄ±tlarÄ±m (' + myRecs.length + ')</h3>';
            if (myRecs.length === 0) html += '<div class="alert alert-info">HenÃ¼z kayÄ±t yok</div>';
            for (var i = myRecs.length - 1; i >= 0; i--) {
                var r = myRecs[i];
                html += '<div class="card"><b>' + r.sname + '</b><br><small>ğŸ“… ' + r.date + ' â€¢ â° ' + r.time + '</small></div>';
            }

            html += '</div>';
            render(html);
        }

        async function saveRecord() {
            if (!APP.location) { 
                alert('âŒ GPS aktif deÄŸil! "GPS Yenile" butonuna basÄ±n.'); 
                return; 
            }
            
            var idx = parseInt(document.getElementById('wss').value);
            
            if (isNaN(idx) || idx < 0) { 
                alert('âŒ Åantiye seÃ§in!'); 
                return; 
            }
            
            var site = APP.sites[idx];
            var now = new Date();
            var date = now.toISOString().split('T')[0];
            var time = now.toLocaleTimeString('tr-TR');
            var id = Date.now().toString();
            
            var success = await saveData('records', [[
                id,
                APP.currentWorker.id,
                APP.currentWorker.name,
                site.id,
                site.name,
                date,
                time,
                APP.location.lat.toString(),
                APP.location.lng.toString()
            ]]);
            
            if (success) {
                alert('âœ… KayÄ±t baÅŸarÄ±lÄ±!\n' + site.name + '\n' + date + ' ' + time);
                showWorkerPanel();
            } else {
                alert('âŒ Google Sheets hatasÄ±! LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
            }
        }

        function logoutWorker() {
            APP.currentWorker = null;
            localStorage.removeItem('currentWorker');
            showHome();
        }

        init();
    </script>
</body>
</html>
