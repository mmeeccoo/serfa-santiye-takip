<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERFA TEKNƒ∞K</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .brand {
            background: #1a1a2e;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            letter-spacing: 3px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 60px);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        .header.worker { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .content { padding: 30px 20px; }
        .home-content { padding: 50px 30px; text-align: center; }
        .home-icon { font-size: 80px; margin-bottom: 30px; }
        h1 { font-size: 24px; margin-bottom: 8px; }
        h2 { font-size: 22px; margin-bottom: 40px; color: #333; }
        .btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-manager { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-worker { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .btn-primary { background: #667eea; }
        .btn-success { background: #2ecc71; }
        .btn-excel { background: #217346; }
        .btn-back { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-refresh { background: #f39c12; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }
        .tabs { display: flex; background: #f5f5f5; }
        .tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
        }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .card { background: #f8f9fa; padding: 15px; margin: 12px 0; border-radius: 10px; border-left: 4px solid #667eea; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-value { font-size: 32px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.9; margin-top: 5px; }
        .alert { padding: 14px; margin: 15px 0; border-radius: 10px; text-align: center; font-weight: 600; }
        .alert-danger { background: #f8d7da; color: #721c24; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .location-badge { 
            display: inline-block; 
            padding: 8px 14px; 
            background: #d4edda; 
            color: #155724; 
            border-radius: 8px; 
            font-size: 13px; 
            margin: 10px 0; 
        }
        .status-card { padding: 40px 30px; border-radius: 14px; text-align: center; margin: 20px 0; color: white; }
        .status-ready { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        h3 { margin: 25px 0 15px; color: #333; font-size: 18px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .settings-box { background: #fff3cd; padding: 15px; border-radius: 10px; margin: 20px 0; }
        .settings-box h4 { margin-bottom: 10px; color: #856404; }
    </style>
</head>
<body>
    <div class="brand">SERFA TEKNƒ∞K</div>
    <div class="container">
        <div id="app"></div>
    </div>

    <script>
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzWBkU3FXmN9HEizbahNVa6UlGnn_0br0xsC8bn3G5zX_NQKxWNNXRnHi4zD_UN0NIp/exec',
            ADMIN_PASSWORD: localStorage.getItem('adminPassword') || '1234'
        };

        const STATE = {
            workers: [],
            sites: [],
            records: [],
            currentWorker: JSON.parse(localStorage.getItem('currentWorker') || 'null'),
            location: null
        };

        // GPS
        function updateGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => { STATE.location = { lat: pos.coords.latitude, lng: pos.coords.longitude }; },
                    () => { STATE.location = null; },
                    { enableHighAccuracy: true }
                );
            }
        }

        // API
        async function apiGet(sheet) {
            const url = CONFIG.SCRIPT_URL + '?sheet=' + sheet;
            const res = await fetch(url);
            const data = await res.json();
            return data.data || [];
        }

        async function apiPost(sheet, values) {
            try {
                const res = await fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sheet: sheet, values: values })
                });
                
                if (!res.ok) {
                    console.error('HTTP Error:', res.status, res.statusText);
                    return false;
                }
                
                const data = await res.json();
                console.log('Response:', data);
                return data.success === true;
            } catch (err) {
                console.error('API Error:', err);
                return false;
            }
        }

        // Render
        function render(html) {
            document.getElementById('app').innerHTML = html;
        }

        function loading() {
            return '<div class="loading"><div class="spinner"></div><p>Y√ºkleniyor...</p></div>';
        }

        // Home
        function showHome() {
            render(`
                <div class="header"><h1>üèóÔ∏è ≈ûantiye Takip Sistemi</h1></div>
                <div class="home-content">
                    <div class="home-icon">üèóÔ∏è</div>
                    <h2>Ho≈ü Geldiniz</h2>
                    <button class="btn btn-manager" onclick="showManagerLogin()">üëî ƒ∞≈üveren</button>
                    <button class="btn btn-worker" onclick="showWorkerLogin()">üë∑ ƒ∞≈ü√ßi</button>
                </div>
            `);
        }

        // Manager Login
        function showManagerLogin() {
            render(`
                <div class="header"><h1>üëî Y√∂netici Giri≈üi</h1></div>
                <div class="content">
                    <button class="btn btn-back" onclick="showHome()">‚Üê Geri</button>
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 60px; margin-bottom: 20px;">üîê</div>
                        <h2>≈ûifre Girin</h2>
                        <div class="form-group"><input type="password" id="pass"></div>
                        <button class="btn btn-primary" onclick="checkManagerPass()">Giri≈ü</button>
                    </div>
                </div>
            `);
        }

        function checkManagerPass() {
            if (document.getElementById('pass').value === CONFIG.ADMIN_PASSWORD) {
                showManagerPanel('add');
            } else {
                alert('‚ùå Hatalƒ± ≈üifre!');
            }
        }

        // Manager Panel
        async function showManagerPanel(tab) {
            render('<div class="header"><h1>üëî Y√∂netici Paneli</h1></div><div class="content">' + loading() + '</div>');
            
            const [workersData, sitesData, recordsData] = await Promise.all([
                apiGet('workers'),
                apiGet('sites'),
                apiGet('records')
            ]);
            
            STATE.workers = workersData.slice(1).filter(r => r[0]).map(r => ({ id: r[0], name: r[1], wage: r[2], password: r[3] }));
            STATE.sites = sitesData.slice(1).filter(r => r[0]).map(r => ({ id: r[0], name: r[1], addr: r[2] }));
            STATE.records = recordsData.slice(1).filter(r => r[0]).map(r => ({ 
                id: r[0], wid: r[1], wname: r[2], sid: r[3], sname: r[4], date: r[5], time: r[6], lat: r[7], lng: r[8] 
            }));
            
            let html = '<div class="header"><h1>üëî Y√∂netici Paneli</h1></div>';
            html += '<div class="tabs">';
            html += '<button class="tab ' + (tab === 'add' ? 'active' : '') + '" onclick="showManagerPanel(\'add\')">‚ûï Ekle</button>';
            html += '<button class="tab ' + (tab === 'list' ? 'active' : '') + '" onclick="showManagerPanel(\'list\')">üìã Liste</button>';
            html += '<button class="tab ' + (tab === 'report' ? 'active' : '') + '" onclick="showManagerPanel(\'report\')">üìä Rapor</button>';
            html += '<button class="tab ' + (tab === 'settings' ? 'active' : '') + '" onclick="showManagerPanel(\'settings\')">‚öôÔ∏è Ayarlar</button>';
            html += '</div><div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">‚Üê √áƒ±kƒ±≈ü</button>';

            if (tab === 'add') {
                html += '<h3>ƒ∞≈ü√ßi Ekle</h3>';
                html += '<div class="form-group"><label>Ad Soyad</label><input id="wn"></div>';
                html += '<div class="form-group"><label>G√ºnl√ºk √úcret (‚Ç∫)</label><input type="number" id="ww"></div>';
                html += '<div class="form-group"><label>PIN Kodu (4 haneli)</label><input type="text" id="wp" maxlength="4"></div>';
                html += '<button class="btn btn-primary" onclick="addWorker()">ƒ∞≈ü√ßi Ekle</button><hr style="margin: 30px 0;">';
                html += '<h3>≈ûantiye Ekle</h3>';
                html += '<div class="form-group"><label>≈ûantiye Adƒ±</label><input id="sn"></div>';
                html += '<div class="form-group"><label>Adres</label><input id="sa"></div>';
                html += '<button class="btn btn-primary" onclick="addSite()">≈ûantiye Ekle</button>';
            } else if (tab === 'list') {
                html += '<h3>ƒ∞≈ü√ßiler (' + STATE.workers.length + ')</h3>';
                STATE.workers.forEach(w => {
                    html += '<div class="card"><b>' + w.name + '</b><br><small>üí∞ ' + w.wage + '‚Ç∫/g√ºn ‚Ä¢ üîê PIN: ' + w.password + '</small></div>';
                });
                html += '<h3>≈ûantiyeler (' + STATE.sites.length + ')</h3>';
                STATE.sites.forEach(s => {
                    html += '<div class="card"><b>' + s.name + '</b><br><small>üìç ' + s.addr + '</small></div>';
                });
                html += '<h3>Kayƒ±tlar (' + STATE.records.length + ')</h3>';
                STATE.records.slice().reverse().forEach(r => {
                    html += '<div class="card"><b>' + r.wname + '</b><br><small>üèóÔ∏è ' + r.sname + ' ‚Ä¢ üìÖ ' + r.date + ' ‚Ä¢ ‚è∞ ' + r.time + '</small></div>';
                });
            } else if (tab === 'report') {
                html += '<button class="btn btn-excel" onclick="exportCSV()">üìä Excel ƒ∞ndir</button>';
                html += '<div class="stats">';
                html += '<div class="stat-box"><div class="stat-value">' + STATE.records.length + '</div><div class="stat-label">TOPLAM KAYIT</div></div>';
                html += '<div class="stat-box"><div class="stat-value">' + STATE.workers.length + '</div><div class="stat-label">AKTƒ∞F ƒ∞≈û√áƒ∞</div></div>';
                html += '</div>';
            } else if (tab === 'settings') {
                html += '<div class="settings-box">';
                html += '<h4>‚öôÔ∏è Y√∂netici ≈ûifresi</h4>';
                html += '<div class="form-group"><label>Mevcut: <b>' + CONFIG.ADMIN_PASSWORD + '</b></label></div>';
                html += '<div class="form-group"><label>Yeni ≈ûifre</label><input type="text" id="newpass"></div>';
                html += '<button class="btn btn-primary" onclick="changePassword()">Deƒüi≈ütir</button>';
                html += '</div>';
            }
            html += '</div>';
            render(html);
        }

        function changePassword() {
            const newPass = document.getElementById('newpass').value.trim();
            if (!newPass || newPass.length < 4) {
                alert('‚ùå ≈ûifre en az 4 karakter olmalƒ±!');
                return;
            }
            CONFIG.ADMIN_PASSWORD = newPass;
            localStorage.setItem('adminPassword', newPass);
            alert('‚úÖ ≈ûifre deƒüi≈ütirildi!');
            showManagerPanel('settings');
        }

        async function addWorker() {
            const n = document.getElementById('wn').value.trim();
            const w = document.getElementById('ww').value.trim();
            const p = document.getElementById('wp').value.trim();
            if (!n || !w || !p || p.length !== 4) {
                alert('‚ùå T√ºm alanlarƒ± doldurun! PIN 4 haneli olmalƒ±.');
                return;
            }
            const ok = await apiPost('workers', [[Date.now().toString(), n, w, p]]);
            if (ok) {
                alert('‚úÖ ƒ∞≈ü√ßi eklendi!\nAd: ' + n + '\nPIN: ' + p);
                showManagerPanel('add');
            } else {
                alert('‚ùå Hata olu≈ütu!');
            }
        }

        async function addSite() {
            const n = document.getElementById('sn').value.trim();
            const a = document.getElementById('sa').value.trim();
            if (!n || !a) {
                alert('‚ùå T√ºm alanlarƒ± doldurun!');
                return;
            }
            const ok = await apiPost('sites', [[Date.now().toString(), n, a]]);
            if (ok) {
                alert('‚úÖ ≈ûantiye eklendi!');
                showManagerPanel('add');
            } else {
                alert('‚ùå Hata olu≈ütu!');
            }
        }

        function exportCSV() {
            let csv = 'ƒ∞≈ü√ßi,≈ûantiye,Tarih,Saat,Enlem,Boylam\n';
            STATE.records.forEach(r => {
                csv += r.wname + ',' + r.sname + ',' + r.date + ',' + r.time + ',' + (r.lat || '') + ',' + (r.lng || '') + '\n';
            });
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'serfa-rapor.csv';
            link.click();
        }

        // Worker Login
        async function showWorkerLogin() {
            render('<div class="header worker"><h1>üë∑ ƒ∞≈ü√ßi Giri≈üi</h1></div><div class="content">' + loading() + '</div>');
            
            const workersData = await apiGet('workers');
            STATE.workers = workersData.slice(1).filter(r => r[0]).map(r => ({ id: r[0], name: r[1], wage: r[2], password: r[3] }));
            
            let html = '<div class="header worker"><h1>üë∑ ƒ∞≈ü√ßi Giri≈üi</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">‚Üê Geri</button>';
            html += '<div style="text-align: center; padding: 40px 20px;">';
            html += '<div style="font-size: 60px; margin-bottom: 20px;">üë∑</div>';
            html += '<h2>ƒ∞sminizi Se√ßin</h2>';
            html += '<div class="form-group"><select id="ws"><option value="">Se√ßin...</option>';
            STATE.workers.forEach((w, i) => {
                html += '<option value="' + i + '">' + w.name + '</option>';
            });
            html += '</select></div>';
            html += '<div class="form-group"><label>PIN Kodu</label><input type="password" id="wpass" maxlength="4"></div>';
            html += '<button class="btn btn-success" onclick="loginWorker()">Giri≈ü</button>';
            html += '</div></div>';
            render(html);
        }

        function loginWorker() {
            const idx = parseInt(document.getElementById('ws').value);
            const pass = document.getElementById('wpass').value.trim();
            
            if (isNaN(idx)) {
                alert('‚ùå ƒ∞≈ü√ßi se√ßin!');
                return;
            }
            if (!pass) {
                alert('‚ùå PIN kodu girin!');
                return;
            }
            
            STATE.currentWorker = STATE.workers[idx];
            
            if (String(STATE.currentWorker.password).trim() !== String(pass).trim()) {
                alert('‚ùå Hatalƒ± PIN!');
                return;
            }
            
            localStorage.setItem('currentWorker', JSON.stringify(STATE.currentWorker));
            showWorkerPanel();
        }

        // Worker Panel
        async function showWorkerPanel() {
            render('<div class="header worker"><h1>üë∑ ' + STATE.currentWorker.name + '</h1></div><div class="content">' + loading() + '</div>');
            
            const [sitesData, recordsData] = await Promise.all([
                apiGet('sites'),
                apiGet('records')
            ]);
            
            STATE.sites = sitesData.slice(1).filter(r => r[0]).map(r => ({ id: r[0], name: r[1], addr: r[2] }));
            STATE.records = recordsData.slice(1).filter(r => r[0] && r[1] === STATE.currentWorker.id).map(r => ({ 
                id: r[0], sname: r[4], date: r[5], time: r[6]
            }));
            
            let html = '<div class="header worker"><h1>üë∑ ' + STATE.currentWorker.name + '</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="logoutWorker()">üö™ √áƒ±kƒ±≈ü</button>';

            if (!STATE.location) {
                html += '<div class="alert alert-danger">‚ö†Ô∏è GPS KAPALI!</div>';
                html += '<button class="btn btn-refresh" onclick="updateGPS(); setTimeout(showWorkerPanel, 1000);">üîÑ GPS Yenile</button>';
            } else {
                html += '<div class="location-badge">‚úÖ GPS Aktif</div>';
            }
            
            html += '<div class="status-card status-ready"><div style="font-size: 60px;">üü¢</div><h2>Hazƒ±r</h2><p>≈ûantiye se√ßin ve kaydedin</p></div>';
            
            html += '<div class="form-group"><label>≈ûantiye Se√ß</label><select id="wss"><option value="">Se√ßin...</option>';
            STATE.sites.forEach((s, i) => {
                html += '<option value="' + i + '">' + s.name + '</option>';
            });
            html += '</select></div>';
            html += '<button class="btn btn-success" onclick="saveWork()" ' + (!STATE.location ? 'disabled' : '') + '>üíæ Kaydet</button>';
            
            html += '<h3>Kayƒ±tlarƒ±m (' + STATE.records.length + ')</h3>';
            STATE.records.slice().reverse().forEach(r => {
                html += '<div class="card"><b>' + r.sname + '</b><br><small>üìÖ ' + r.date + ' ‚Ä¢ ‚è∞ ' + r.time + '</small></div>';
            });

            html += '</div>';
            render(html);
        }

        async function saveWork() {
            if (!STATE.location) {
                alert('‚ùå GPS aktif deƒüil!');
                return;
            }
            
            const idx = parseInt(document.getElementById('wss').value);
            if (isNaN(idx)) {
                alert('‚ùå ≈ûantiye se√ßin!');
                return;
            }
            
            const site = STATE.sites[idx];
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toLocaleTimeString('tr-TR');
            
            const ok = await apiPost('records', [[
                Date.now().toString(),
                STATE.currentWorker.id,
                STATE.currentWorker.name,
                site.id,
                site.name,
                date,
                time,
                STATE.location.lat.toString(),
                STATE.location.lng.toString()
            ]]);
            
            if (ok) {
                alert('‚úÖ Kayƒ±t ba≈üarƒ±lƒ±!\n' + site.name + '\n' + date + ' ' + time);
                showWorkerPanel();
            } else {
                alert('‚ùå Kayƒ±t ba≈üarƒ±sƒ±z! Tekrar deneyin.');
            }
        }

        function logoutWorker() {
            STATE.currentWorker = null;
            localStorage.removeItem('currentWorker');
            showHome();
        }

        // Init
        updateGPS();
        setInterval(updateGPS, 30000);
        showHome();
    </script>
</body>
</html>
