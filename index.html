<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERFA TEKNƒ∞K</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .brand {
            background: #1a1a2e;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            letter-spacing: 3px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 60px);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        .header.worker { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .content { padding: 30px 20px; }
        .home-content { padding: 50px 30px; text-align: center; }
        .home-icon { font-size: 80px; margin-bottom: 30px; }
        h1 { font-size: 24px; margin-bottom: 8px; }
        h2 { font-size: 22px; margin-bottom: 40px; color: #333; }
        .btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .btn-manager { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-worker { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .btn-primary { background: #667eea; }
        .btn-success { background: #2ecc71; }
        .btn-danger { background: #e74c3c; }
        .btn-excel { background: #217346; }
        .btn-back { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-refresh { background: #f39c12; margin-top: 10px; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }
        .tabs { display: flex; background: #f5f5f5; }
        .tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
        }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .card { background: #f8f9fa; padding: 15px; margin: 12px 0; border-radius: 10px; border-left: 4px solid #667eea; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-value { font-size: 32px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.9; margin-top: 5px; }
        .alert { padding: 14px; margin: 15px 0; border-radius: 10px; text-align: center; font-weight: 600; }
        .alert-danger { background: #f8d7da; color: #721c24; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-warning { background: #fff3cd; color: #856404; }
        .location-badge { 
            display: inline-block; 
            padding: 8px 14px; 
            background: #d4edda; 
            color: #155724; 
            border-radius: 8px; 
            font-size: 13px; 
            margin: 10px 0; 
        }
        .location-badge.checking { background: #fff3cd; color: #856404; }
        .status-card { padding: 40px 30px; border-radius: 14px; text-align: center; margin: 20px 0; color: white; }
        .status-ready { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .status-working { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .photo-preview { margin-top: 15px; border-radius: 10px; overflow: hidden; }
        .photo-preview img { width: 100%; height: auto; display: block; }
        h3 { margin: 25px 0 15px; color: #333; font-size: 18px; }
    </style>
</head>
<body>
    <div class="brand">SERFA TEKNƒ∞K</div>
    <div class="container">
        <div id="app"></div>
    </div>

    <script>
        var APP = {
            workers: JSON.parse(localStorage.getItem('workers') || '[]'),
            sites: JSON.parse(localStorage.getItem('sites') || '[]'),
            records: JSON.parse(localStorage.getItem('records') || '[]'),
            currentWorker: JSON.parse(localStorage.getItem('currentWorker') || 'null'),
            workStart: JSON.parse(localStorage.getItem('workStart') || 'null'),
            location: null,
            locationStatus: 'checking',
            PASSWORD: '1234'
        };

        function init() {
            forceGetLocation();
            showHome();
        }

        function forceGetLocation() {
            APP.locationStatus = 'checking';
            if (!navigator.geolocation) {
                APP.locationStatus = 'not-supported';
                APP.location = null;
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(pos) { 
                    APP.location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    APP.locationStatus = 'active';
                    console.log('GPS OK:', APP.location);
                    if (APP.currentWorker) showWorkerPanel();
                },
                function(err) { 
                    APP.location = null;
                    APP.locationStatus = 'denied';
                    console.error('GPS ERROR:', err.message);
                    if (APP.currentWorker) showWorkerPanel();
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function render(html) {
            document.getElementById('app').innerHTML = html;
        }

        function showHome() {
            var html = '<div class="header"><h1>üèóÔ∏è ≈ûantiye Takip Sistemi</h1><p>Profesyonel ƒ∞n≈üaat Y√∂netimi</p></div>';
            html += '<div class="home-content">';
            html += '<div class="home-icon">üèóÔ∏è</div>';
            html += '<h2>Ho≈ü Geldiniz</h2>';
            html += '<button class="btn btn-manager" onclick="showManagerLogin()">üëî ƒ∞≈üveren / Y√∂netici</button>';
            html += '<button class="btn btn-worker" onclick="showWorkerLogin()">üë∑ ƒ∞≈ü√ßi</button>';
            html += '</div>';
            render(html);
        }

        function showManagerLogin() {
            var html = '<div class="header"><h1>üëî Y√∂netici Giri≈üi</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">‚Üê Geri</button>';
            html += '<div style="text-align: center; padding: 40px 20px;">';
            html += '<div style="font-size: 60px; margin-bottom: 20px;">üîê</div>';
            html += '<h2>≈ûifre Girin</h2>';
            html += '<div class="form-group"><input type="password" id="pass" placeholder="≈ûifre (1234)"></div>';
            html += '<button class="btn btn-primary" onclick="checkPass()">Giri≈ü</button>';
            html += '</div></div>';
            render(html);
        }

        function checkPass() {
            if (document.getElementById('pass').value === APP.PASSWORD) {
                showManagerPanel('add');
            } else {
                alert('Hatalƒ± ≈üifre!');
            }
        }

        function showManagerPanel(tab) {
            var html = '<div class="header"><h1>üëî Y√∂netici Paneli</h1></div>';
            html += '<div class="tabs">';
            html += '<button class="tab ' + (tab === 'add' ? 'active' : '') + '" onclick="showManagerPanel(\'add\')">‚ûï Ekle</button>';
            html += '<button class="tab ' + (tab === 'list' ? 'active' : '') + '" onclick="showManagerPanel(\'list\')">üìã Liste</button>';
            html += '<button class="tab ' + (tab === 'report' ? 'active' : '') + '" onclick="showManagerPanel(\'report\')">üìä Rapor</button>';
            html += '</div><div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">‚Üê √áƒ±kƒ±≈ü</button>';

            if (tab === 'add') {
                html += '<h3>ƒ∞≈ü√ßi Ekle</h3>';
                html += '<div class="form-group"><label>Ad Soyad</label><input id="wn"></div>';
                html += '<div class="form-group"><label>G√ºnl√ºk √úcret (‚Ç∫)</label><input type="number" id="ww"></div>';
                html += '<button class="btn btn-primary" onclick="addWorker()">Ekle</button><hr style="margin: 30px 0;">';
                html += '<h3>≈ûantiye Ekle</h3>';
                html += '<div class="form-group"><label>≈ûantiye Adƒ±</label><input id="sn"></div>';
                html += '<div class="form-group"><label>Adres</label><input id="sa"></div>';
                html += '<button class="btn btn-primary" onclick="addSite()">Ekle</button>';
            } else if (tab === 'list') {
                html += '<h3>ƒ∞≈ü√ßiler (' + APP.workers.length + ')</h3>';
                for (var i = 0; i < APP.workers.length; i++) {
                    html += '<div class="card"><b>' + APP.workers[i].name + '</b><br><small>üí∞ ' + APP.workers[i].wage + '‚Ç∫/g√ºn</small></div>';
                }
                html += '<h3>≈ûantiyeler (' + APP.sites.length + ')</h3>';
                for (var i = 0; i < APP.sites.length; i++) {
                    html += '<div class="card"><b>' + APP.sites[i].name + '</b><br><small>üìç ' + APP.sites[i].addr + '</small></div>';
                }
                html += '<h3>Kayƒ±tlar (' + APP.records.length + ')</h3>';
                for (var i = APP.records.length - 1; i >= 0; i--) {
                    var r = APP.records[i];
                    html += '<div class="card"><b>' + r.wname + ' - ' + r.cost + '‚Ç∫</b><br><small>' + r.sname + ' ‚Ä¢ ' + r.date + ' ‚Ä¢ ' + r.hours + ' saat</small>';
                    if (r.photo) html += '<div class="photo-preview"><img src="' + r.photo + '"></div>';
                    html += '</div>';
                }
            } else if (tab === 'report') {
                var totalC = 0, totalH = 0;
                for (var i = 0; i < APP.records.length; i++) {
                    totalC += parseFloat(APP.records[i].cost);
                    totalH += parseFloat(APP.records[i].hours);
                }
                html += '<button class="btn btn-excel" onclick="exportExcel()">üìä Excel\'e D√∂k√ºmle</button>';
                html += '<div class="stats">';
                html += '<div class="stat-box"><div class="stat-value">' + totalH.toFixed(1) + '</div><div class="stat-label">TOPLAM SAAT</div></div>';
                html += '<div class="stat-box"><div class="stat-value">' + totalC.toFixed(0) + '‚Ç∫</div><div class="stat-label">TOPLAM MALƒ∞YET</div></div>';
                html += '</div>';
            }
            html += '</div>';
            render(html);
        }

        function addWorker() {
            var n = document.getElementById('wn').value.trim();
            var w = document.getElementById('ww').value.trim();
            if (!n || !w) { alert('Eksik bilgi!'); return; }
            APP.workers.push({ id: Date.now(), name: n, wage: w });
            localStorage.setItem('workers', JSON.stringify(APP.workers));
            alert('‚úÖ Eklendi!');
            showManagerPanel('add');
        }

        function addSite() {
            var n = document.getElementById('sn').value.trim();
            var a = document.getElementById('sa').value.trim();
            if (!n || !a) { alert('Eksik bilgi!'); return; }
            APP.sites.push({ id: Date.now(), name: n, addr: a });
            localStorage.setItem('sites', JSON.stringify(APP.sites));
            alert('‚úÖ Eklendi!');
            showManagerPanel('add');
        }

        function exportExcel() {
            var csv = 'ƒ∞≈ü√ßi,≈ûantiye,Tarih,Saat,Maliyet\n';
            for (var i = 0; i < APP.records.length; i++) {
                var r = APP.records[i];
                csv += r.wname + ',' + r.sname + ',' + r.date + ',' + r.hours + ',' + r.cost + '\n';
            }
            var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'serfa-rapor.csv';
            link.click();
        }

        function showWorkerLogin() {
            if (APP.workers.length === 0) { alert('Hen√ºz i≈ü√ßi yok!'); showHome(); return; }
            var html = '<div class="header worker"><h1>üë∑ ƒ∞≈ü√ßi Giri≈üi</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">‚Üê Geri</button>';
            html += '<div style="text-align: center; padding: 40px 20px;">';
            html += '<div style="font-size: 60px; margin-bottom: 20px;">üë∑</div>';
            html += '<h2>ƒ∞sminizi Se√ßin</h2>';
            html += '<div class="form-group"><select id="ws"><option value="">Se√ßin...</option>';
            for (var i = 0; i < APP.workers.length; i++) {
                html += '<option value="' + APP.workers[i].id + '">' + APP.workers[i].name + '</option>';
            }
            html += '</select></div>';
            html += '<button class="btn btn-success" onclick="loginWorker()">Giri≈ü</button>';
            html += '</div></div>';
            render(html);
        }

        function loginWorker() {
            var id = parseInt(document.getElementById('ws').value);
            if (!id) { alert('ƒ∞≈ü√ßi se√ßin!'); return; }
            for (var i = 0; i < APP.workers.length; i++) {
                if (APP.workers[i].id === id) {
                    APP.currentWorker = APP.workers[i];
                    break;
                }
            }
            localStorage.setItem('currentWorker', JSON.stringify(APP.currentWorker));
            forceGetLocation();
            setTimeout(showWorkerPanel, 500);
        }

        function showWorkerPanel() {
            var myRecs = [];
            for (var i = 0; i < APP.records.length; i++) {
                if (APP.records[i].wid === APP.currentWorker.id) {
                    myRecs.push(APP.records[i]);
                }
            }

            var html = '<div class="header worker"><h1>üë∑ ' + APP.currentWorker.name + '</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="logoutWorker()">üö™ √áƒ±kƒ±≈ü</button>';

            if (!APP.workStart) {
                if (APP.locationStatus === 'checking') {
                    html += '<div class="location-badge checking">‚è≥ GPS Kontrol Ediliyor...</div>';
                } else if (APP.locationStatus === 'denied' || !APP.location) {
                    html += '<div class="alert alert-danger">‚ö†Ô∏è GPS KAPALI! L√ºtfen ayarlardan konum iznini verin.</div>';
                    html += '<button class="btn btn-refresh" onclick="forceGetLocation(); setTimeout(showWorkerPanel, 500);">üîÑ GPS\'i Yeniden Dene</button>';
                } else {
                    html += '<div class="location-badge">‚úÖ GPS Aktif: ' + APP.location.lat.toFixed(4) + ', ' + APP.location.lng.toFixed(4) + '</div>';
                }
                
                html += '<div class="status-card status-ready"><div style="font-size: 60px; margin-bottom: 15px;">üü¢</div><h2>Hazƒ±r</h2><p>√áalƒ±≈ümaya ba≈ülamak i√ßin ≈üantiye se√ßin</p></div>';
                html += '<div class="form-group"><label>≈ûantiye Se√ß</label><select id="wss"><option value="">Se√ßin...</option>';
                for (var i = 0; i < APP.sites.length; i++) {
                    html += '<option value="' + APP.sites[i].id + '">' + APP.sites[i].name + '</option>';
                }
                html += '</select></div>';
                html += '<button class="btn btn-success" onclick="startWork()" ' + (!APP.location ? 'disabled' : '') + '>üöÄ √áalƒ±≈ümaya Ba≈üla</button>';
                html += '<h3>Y√ºklediƒüim Kayƒ±tlar (' + myRecs.length + ')</h3>';
                for (var i = myRecs.length - 1; i >= 0; i--) {
                    var r = myRecs[i];
                    html += '<div class="card"><b>' + r.sname + '</b><br><small>' + r.date + ' ‚Ä¢ ' + r.hours + ' saat</small>';
                    if (r.photo) html += '<div class="photo-preview"><img src="' + r.photo + '"></div>';
                    html += '</div>';
                }
            } else {
                html += '<div class="alert alert-success">‚ö° √áalƒ±≈üma devam ediyor...</div>';
                html += '<div class="status-card status-working"><div style="font-size: 60px; margin-bottom: 15px;">‚ö°</div><h2>' + APP.workStart.sname + '</h2><p>Ba≈ülangƒ±√ß: ' + new Date(APP.workStart.time).toLocaleTimeString('tr-TR') + '</p></div>';
                html += '<div class="form-group"><label>Fotoƒüraf (Zorunlu)</label><input type="file" id="wp" accept="image/*" capture="environment" style="width:100%;padding:12px;border:2px dashed #2ecc71;border-radius:10px;"></div>';
                html += '<button class="btn btn-danger" onclick="endWork()">‚èπÔ∏è Bitir ve Kaydet</button>';
            }
            html += '</div>';
            render(html);
        }

        function startWork() {
            if (!APP.location) { 
                alert('‚ùå GPS aktif deƒüil! L√ºtfen GPS iznini verin ve tekrar deneyin.'); 
                forceGetLocation();
                setTimeout(showWorkerPanel, 500);
                return; 
            }
            var sid = parseInt(document.getElementById('wss').value);
            if (!sid) { alert('‚ùå L√ºtfen ≈üantiye se√ßin!'); return; }
            var site = null;
            for (var i = 0; i < APP.sites.length; i++) {
                if (APP.sites[i].id === sid) { site = APP.sites[i]; break; }
            }
            APP.workStart = { 
                wid: APP.currentWorker.id, 
                wname: APP.currentWorker.name, 
                sid: sid, 
                sname: site.name, 
                time: Date.now(),
                startLoc: { lat: APP.location.lat, lng: APP.location.lng }
            };
            localStorage.setItem('workStart', JSON.stringify(APP.workStart));
            alert('‚úÖ √áalƒ±≈üma ba≈üladƒ±!');
            showWorkerPanel();
        }

        function endWork() {
            forceGetLocation();
            setTimeout(function() {
                if (!APP.location) { 
                    alert('‚ö†Ô∏è GPS sinyali alƒ±namƒ±yor! L√ºtfen GPS\'i a√ßƒ±n ve tekrar deneyin.'); 
                    return; 
                }
                var pf = document.getElementById('wp').files[0];
                if (!pf) { alert('‚ùå L√ºtfen √ßalƒ±≈üma fotoƒürafƒ± y√ºkleyin!'); return; }
                var reader = new FileReader();
                reader.onload = function(e) {
                    var h = ((Date.now() - APP.workStart.time) / 3600000).toFixed(2);
                    var c = ((parseFloat(APP.currentWorker.wage) / 8) * parseFloat(h)).toFixed(2);
                    APP.records.push({
                        id: Date.now(),
                        wid: APP.workStart.wid,
                        wname: APP.workStart.wname,
                        sid: APP.workStart.sid,
                        sname: APP.workStart.sname,
                        date: new Date().toISOString().split('T')[0],
                        hours: h,
                        cost: c,
                        photo: e.target.result,
                        startLoc: APP.workStart.startLoc,
                        endLoc: { lat: APP.location.lat, lng: APP.location.lng }
                    });
                    localStorage.setItem('records', JSON.stringify(APP.records));
                    APP.workStart = null;
                    localStorage.removeItem('workStart');
                    alert('‚úÖ Tamamlandƒ±! ' + h + ' saat kaydedildi.');
                    showWorkerPanel();
                };
                reader.readAsDataURL(pf);
            }, 1000);
        }

        function logoutWorker() {
            if (APP.workStart && !confirm('‚ö†Ô∏è √áalƒ±≈üma devam ediyor! √áƒ±karsanƒ±z kayƒ±t silinecek. Emin misiniz?')) return;
            APP.currentWorker = null;
            APP.workStart = null;
            localStorage.removeItem('currentWorker');
            localStorage.removeItem('workStart');
            showHome();
        }

        init();
    </script>
</body>
</html>
