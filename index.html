<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERFA TEKNÄ°K</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .brand {
            background: #1a1a2e;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            letter-spacing: 3px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 60px);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        .header.worker { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .content { padding: 30px 20px; }
        .home-content { padding: 50px 30px; text-align: center; }
        .home-icon { font-size: 80px; margin-bottom: 30px; }
        h1 { font-size: 24px; margin-bottom: 8px; }
        h2 { font-size: 22px; margin-bottom: 40px; color: #333; }
        .btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-manager { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-worker { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .btn-primary { background: #667eea; }
        .btn-success { background: #2ecc71; }
        .btn-excel { background: #217346; }
        .btn-back { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-refresh { background: #f39c12; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }
        .tabs { display: flex; background: #f5f5f5; }
        .tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
        }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .card { background: #f8f9fa; padding: 15px; margin: 12px 0; border-radius: 10px; border-left: 4px solid #667eea; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-value { font-size: 32px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.9; margin-top: 5px; }
        .alert { padding: 14px; margin: 15px 0; border-radius: 10px; text-align: center; font-weight: 600; }
        .alert-danger { background: #f8d7da; color: #721c24; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .location-badge { 
            display: inline-block; 
            padding: 8px 14px; 
            background: #d4edda; 
            color: #155724; 
            border-radius: 8px; 
            font-size: 13px; 
            margin: 10px 0; 
        }
        .status-card { padding: 40px 30px; border-radius: 14px; text-align: center; margin: 20px 0; color: white; }
        .status-ready { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        h3 { margin: 25px 0 15px; color: #333; font-size: 18px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .settings-box { background: #fff3cd; padding: 15px; border-radius: 10px; margin: 20px 0; }
        .settings-box h4 { margin-bottom: 10px; color: #856404; }
    </style>
</head>
<body>
    <div class="brand">SERFA TEKNÄ°K</div>
    <div class="container">
        <div id="app"></div>
    </div>

    <script>
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxpQws9sY4EAREhfD36qpBaCoBuRF_Z6IqN586LYRxhVPsJCX6TY5LZonMgdif6ijHq/exec',
            ADMIN_PASSWORD: localStorage.getItem('adminPassword') || '1234'
        };

        const STATE = {
            workers: [],
            sites: [],
            records: [],
            currentWorker: JSON.parse(localStorage.getItem('currentWorker') || 'null'),
            location: null
        };

        // GPS
        function updateGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => { STATE.location = { lat: pos.coords.latitude, lng: pos.coords.longitude }; },
                    () => { STATE.location = null; },
                    { enableHighAccuracy: true }
                );
            }
        }

        // API
        async function apiGet(sheet) {
            const url = CONFIG.SCRIPT_URL + '?sheet=' + sheet;
            const res = await fetch(url);
            const data = await res.json();
            return data.data || [];
        }

        async function apiPost(sheet, values) {
            const res = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ sheet: sheet, values: values })
            });
            const data = await res.json();
            return data.success === true;
        }

        // Render
        function render(html) {
            document.getElementById('app').innerHTML = html;
        }

        function loading() {
            return '<div class="loading"><div class="spinner"></div><p>YÃ¼kleniyor...</p></div>';
        }

        // Home
        function showHome() {
            render(`
                <div class="header"><h1>ğŸ—ï¸ Åantiye Takip Sistemi</h1></div>
                <div class="home-content">
                    <div class="home-icon">ğŸ—ï¸</div>
                    <h2>HoÅŸ Geldiniz</h2>
                    <button class="btn btn-manager" onclick="showManagerLogin()">ğŸ‘” Ä°ÅŸveren</button>
                    <button class="btn btn-worker" onclick="showWorkerLogin()">ğŸ‘· Ä°ÅŸÃ§i</button>
                </div>
            `);
        }

        // Manager Login
        function showManagerLogin() {
            render(`
                <div class="header"><h1>ğŸ‘” YÃ¶netici GiriÅŸi</h1></div>
                <div class="content">
                    <button class="btn btn-back" onclick="showHome()">â† Geri</button>
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ”</div>
                        <h2>Åifre Girin</h2>
                        <div class="form-group"><input type="password" id="pass"></div>
                        <button class="btn btn-primary" onclick="checkManagerPass()">GiriÅŸ</button>
                    </div>
                </div>
            `);
        }

        function checkManagerPass() {
            if (document.getElementById('pass').value === CONFIG.ADMIN_PASSWORD) {
                showManagerPanel('add');
            } else {
                alert('âŒ HatalÄ± ÅŸifre!');
            }
        }

        // Manager Panel
        async function showManagerPanel(tab) {
            render('<div class="header"><h1>ğŸ‘” YÃ¶netici Paneli</h1></div><div class="content">' + loading() + '</div>');
            
            const [workersData, sitesData, recordsData] = await Promise.all([
                apiGet('workers'),
                apiGet('sites'),
                apiGet('records')
            ]);
            
            STATE.workers = workersData.slice(1).filter(r => r[0]).map(r => ({ id: r[0], name: r[1], wage: r[2], password: r[3] }));
            STATE.sites = sitesData.slice(1).filter(r => r[0]).map(r => ({ id: r[0], name: r[1], addr: r[2] }));
            STATE.records = recordsData.slice(1).filter(r => r[0]).map(r => ({ 
                id: r[0], wid: r[1], wname: r[2], sid: r[3], sname: r[4], date: r[5], time: r[6], lat: r[7], lng: r[8] 
            }));
            
            let html = '<div class="header"><h1>ğŸ‘” YÃ¶netici Paneli</h1></div>';
            html += '<div class="tabs">';
            html += '<button class="tab ' + (tab === 'add' ? 'active' : '') + '" onclick="showManagerPanel(\'add\')">â• Ekle</button>';
            html += '<button class="tab ' + (tab === 'list' ? 'active' : '') + '" onclick="showManagerPanel(\'list\')">ğŸ“‹ Liste</button>';
            html += '<button class="tab ' + (tab === 'report' ? 'active' : '') + '" onclick="showManagerPanel(\'report\')">ğŸ“Š Rapor</button>';
            html += '<button class="tab ' + (tab === 'settings' ? 'active' : '') + '" onclick="showManagerPanel(\'settings\')">âš™ï¸ Ayarlar</button>';
            html += '</div><div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">â† Ã‡Ä±kÄ±ÅŸ</button>';

            if (tab === 'add') {
                html += '<h3>Ä°ÅŸÃ§i Ekle</h3>';
                html += '<div class="form-group"><label>Ad Soyad</label><input id="wn"></div>';
                html += '<div class="form-group"><label>GÃ¼nlÃ¼k Ãœcret (â‚º)</label><input type="number" id="ww"></div>';
                html += '<div class="form-group"><label>PIN Kodu (4 haneli)</label><input type="text" id="wp" maxlength="4"></div>';
                html += '<button class="btn btn-primary" onclick="addWorker()">Ä°ÅŸÃ§i Ekle</button><hr style="margin: 30px 0;">';
                html += '<h3>Åantiye Ekle</h3>';
                html += '<div class="form-group"><label>Åantiye AdÄ±</label><input id="sn"></div>';
                html += '<div class="form-group"><label>Adres</label><input id="sa"></div>';
                html += '<button class="btn btn-primary" onclick="addSite()">Åantiye Ekle</button>';
            } else if (tab === 'list') {
                html += '<h3>Ä°ÅŸÃ§iler (' + STATE.workers.length + ')</h3>';
                STATE.workers.forEach(w => {
                    html += '<div class="card"><b>' + w.name + '</b><br><small>ğŸ’° ' + w.wage + 'â‚º/gÃ¼n â€¢ ğŸ” PIN: ' + w.password + '</small></div>';
                });
                html += '<h3>Åantiyeler (' + STATE.sites.length + ')</h3>';
                STATE.sites.forEach(s => {
                    html += '<div class="card"><b>' + s.name + '</b><br><small>ğŸ“ ' + s.addr + '</small></div>';
                });
                html += '<h3>KayÄ±tlar (' + STATE.records.length + ')</h3>';
                STATE.records.slice().reverse().forEach(r => {
                    html += '<div class="card"><b>' + r.wname + '</b><br><small>ğŸ—ï¸ ' + r.sname + ' â€¢ ğŸ“… ' + r.date + ' â€¢ â° ' + r.time + '</small></div>';
                });
            } else if (tab === 'report') {
                html += '<button class="btn btn-excel" onclick="exportCSV()">ğŸ“Š Excel Ä°ndir</button>';
                html += '<div class="stats">';
                html += '<div class="stat-box"><div class="stat-value">' + STATE.records.length + '</div><div class="stat-label">TOPLAM KAYIT</div></div>';
                html += '<div class="stat-box"><div class="stat-value">' + STATE.workers.length + '</div><div class="stat-label">AKTÄ°F Ä°ÅÃ‡Ä°</div></div>';
                html += '</div>';
            } else if (tab === 'settings') {
                html += '<div class="settings-box">';
                html += '<h4>âš™ï¸ YÃ¶netici Åifresi</h4>';
                html += '<div class="form-group"><label>Mevcut: <b>' + CONFIG.ADMIN_PASSWORD + '</b></label></div>';
                html += '<div class="form-group"><label>Yeni Åifre</label><input type="text" id="newpass"></div>';
                html += '<button class="btn btn-primary" onclick="changePassword()">DeÄŸiÅŸtir</button>';
                html += '</div>';
            }
            html += '</div>';
            render(html);
        }

        function changePassword() {
            const newPass = document.getElementById('newpass').value.trim();
            if (!newPass || newPass.length < 4) {
                alert('âŒ Åifre en az 4 karakter olmalÄ±!');
                return;
            }
            CONFIG.ADMIN_PASSWORD = newPass;
            localStorage.setItem('adminPassword', newPass);
            alert('âœ… Åifre deÄŸiÅŸtirildi!');
            showManagerPanel('settings');
        }

        async function addWorker() {
            const n = document.getElementById('wn').value.trim();
            const w = document.getElementById('ww').value.trim();
            const p = document.getElementById('wp').value.trim();
            if (!n || !w || !p || p.length !== 4) {
                alert('âŒ TÃ¼m alanlarÄ± doldurun! PIN 4 haneli olmalÄ±.');
                return;
            }
            const ok = await apiPost('workers', [[Date.now().toString(), n, w, p]]);
            if (ok) {
                alert('âœ… Ä°ÅŸÃ§i eklendi!\nAd: ' + n + '\nPIN: ' + p);
                showManagerPanel('add');
            } else {
                alert('âŒ Hata oluÅŸtu!');
            }
        }

        async function addSite() {
            const n = document.getElementById('sn').value.trim();
            const a = document.getElementById('sa').value.trim();
            if (!n || !a) {
                alert('âŒ TÃ¼m alanlarÄ± doldurun!');
                return;
            }
            const ok = await apiPost('sites', [[Date.now().toString(), n, a]]);
            if (ok) {
                alert('âœ… Åantiye eklendi!');
                showManagerPanel('add');
            } else {
                alert('âŒ Hata oluÅŸtu!');
            }
        }

        function exportCSV() {
            let csv = 'Ä°ÅŸÃ§i,Åantiye,Tarih,Saat,Enlem,Boylam\n';
            STATE.records.forEach(r => {
                csv += r.wname + ',' + r.sname + ',' + r.date + ',' + r.time + ',' + (r.lat || '') + ',' + (r.lng || '') + '\n';
            });
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'serfa-rapor.csv';
            link.click();
        }

        // Worker Login
        async function showWorkerLogin() {
            render('<div class="header worker"><h1>ğŸ‘· Ä°ÅŸÃ§i GiriÅŸi</h1></div><div class="content">' + loading() + '</div>');
            
            const workersData = await apiGet('workers');
            STATE.workers = workersData.slice(1).filter(r => r[0]).map(r => ({ id: r[0], name: r[1], wage: r[2], password: r[3] }));
            
            let html = '<div class="header worker"><h1>ğŸ‘· Ä°ÅŸÃ§i GiriÅŸi</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">â† Geri</button>';
            html += '<div style="text-align: center; padding: 40px 20px;">';
            html += '<div style="font-size: 60px; margin-bottom: 20px;">ğŸ‘·</div>';
            html += '<h2>Ä°sminizi SeÃ§in</h2>';
            html += '<div class="form-group"><select id="ws"><option value="">SeÃ§in...</option>';
            STATE.workers.forEach((w, i) => {
                html += '<option value="' + i + '">' + w.name + '</option>';
            });
            html += '</select></div>';
            html += '<div class="form-group"><label>PIN Kodu</label><input type="password" id="wpass" maxlength="4"></div>';
            html += '<button class="btn btn-success" onclick="loginWorker()">GiriÅŸ</button>';
            html += '</div></div>';
            render(html);
        }

        function loginWorker() {
            const idx = parseInt(document.getElementById('ws').value);
            const pass = document.getElementById('wpass').value.trim();
            
            if (isNaN(idx)) {
                alert('âŒ Ä°ÅŸÃ§i seÃ§in!');
                return;
            }
            if (!pass) {
                alert('âŒ PIN kodu girin!');
                return;
            }
            
            STATE.currentWorker = STATE.workers[idx];
            
            if (String(STATE.currentWorker.password).trim() !== String(pass).trim()) {
                alert('âŒ HatalÄ± PIN!');
                return;
            }
            
            localStorage.setItem('currentWorker', JSON.stringify(STATE.currentWorker));
            showWorkerPanel();
        }

        // Worker Panel
        async function showWorkerPanel() {
            render('<div class="header worker"><h1>ğŸ‘· ' + STATE.currentWorker.name + '</h1></div><div class="content">' + loading() + '</div>');
            
            const [sitesData, recordsData] = await Promise.all([
                apiGet('sites'),
                apiGet('records')
            ]);
            
            STATE.sites = sitesData.slice(1).filter(r => r[0]).map(r => ({ id: r[0], name: r[1], addr: r[2] }));
            STATE.records = recordsData.slice(1).filter(r => r[0] && r[1] === STATE.currentWorker.id).map(r => ({ 
                id: r[0], sname: r[4], date: r[5], time: r[6]
            }));
            
            let html = '<div class="header worker"><h1>ğŸ‘· ' + STATE.currentWorker.name + '</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="logoutWorker()">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>';

            if (!STATE.location) {
                html += '<div class="alert alert-danger">âš ï¸ GPS KAPALI!</div>';
                html += '<button class="btn btn-refresh" onclick="updateGPS(); setTimeout(showWorkerPanel, 1000);">ğŸ”„ GPS Yenile</button>';
            } else {
                html += '<div class="location-badge">âœ… GPS Aktif</div>';
            }
            
            html += '<div class="status-card status-ready"><div style="font-size: 60px;">ğŸŸ¢</div><h2>HazÄ±r</h2><p>Åantiye seÃ§in ve kaydedin</p></div>';
            
            html += '<div class="form-group"><label>Åantiye SeÃ§</label><select id="wss"><option value="">SeÃ§in...</option>';
            STATE.sites.forEach((s, i) => {
                html += '<option value="' + i + '">' + s.name + '</option>';
            });
            html += '</select></div>';
            html += '<button class="btn btn-success" onclick="saveWork()" ' + (!STATE.location ? 'disabled' : '') + '>ğŸ’¾ Kaydet</button>';
            
            html += '<h3>KayÄ±tlarÄ±m (' + STATE.records.length + ')</h3>';
            STATE.records.slice().reverse().forEach(r => {
                html += '<div class="card"><b>' + r.sname + '</b><br><small>ğŸ“… ' + r.date + ' â€¢ â° ' + r.time + '</small></div>';
            });

            html += '</div>';
            render(html);
        }

        async function saveWork() {
            if (!STATE.location) {
                alert('âŒ GPS aktif deÄŸil!');
                return;
            }
            
            const idx = parseInt(document.getElementById('wss').value);
            if (isNaN(idx)) {
                alert('âŒ Åantiye seÃ§in!');
                return;
            }
            
            const site = STATE.sites[idx];
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toLocaleTimeString('tr-TR');
            
            const ok = await apiPost('records', [[
                Date.now().toString(),
                STATE.currentWorker.id,
                STATE.currentWorker.name,
                site.id,
                site.name,
                date,
                time,
                STATE.location.lat.toString(),
                STATE.location.lng.toString()
            ]]);
            
            if (ok) {
                alert('âœ… KayÄ±t baÅŸarÄ±lÄ±!\n' + site.name + '\n' + date + ' ' + time);
                showWorkerPanel();
            } else {
                alert('âŒ KayÄ±t baÅŸarÄ±sÄ±z! Tekrar deneyin.');
            }
        }

        function logoutWorker() {
            STATE.currentWorker = null;
            localStorage.removeItem('currentWorker');
            showHome();
        }

        // Init
        updateGPS();
        setInterval(updateGPS, 30000);
        showHome();
    </script>
</body>
</html>
