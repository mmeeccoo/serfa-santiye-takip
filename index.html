<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SERFA TEKNƒ∞K</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .brand {
            background: #1a1a2e;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            letter-spacing: 3px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 60px);
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        .header.worker { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .content { padding: 30px 20px; }
        .home-content { padding: 50px 30px; text-align: center; }
        .home-icon { font-size: 80px; margin-bottom: 30px; }
        h1 { font-size: 24px; margin-bottom: 8px; }
        h2 { font-size: 22px; margin-bottom: 40px; color: #333; }
        .btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-manager { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-worker { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .btn-primary { background: #667eea; }
        .btn-success { background: #2ecc71; }
        .btn-danger { background: #e74c3c; }
        .btn-excel { background: #217346; }
        .btn-back { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-refresh { background: #f39c12; }
        .btn-delete { background: #e74c3c; padding: 8px 12px; font-size: 13px; margin: 5px 0; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }
        .tabs { display: flex; background: #f5f5f5; }
        .tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
        }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .card { background: #f8f9fa; padding: 15px; margin: 12px 0; border-radius: 10px; border-left: 4px solid #667eea; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-value { font-size: 32px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.9; margin-top: 5px; }
        .alert { padding: 14px; margin: 15px 0; border-radius: 10px; text-align: center; font-weight: 600; }
        .alert-danger { background: #f8d7da; color: #721c24; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .alert-warning { background: #fff3cd; color: #856404; }
        .location-badge { 
            display: inline-block; 
            padding: 8px 14px; 
            background: #d4edda; 
            color: #155724; 
            border-radius: 8px; 
            font-size: 13px; 
            margin: 10px 0; 
        }
        .status-card { padding: 40px 30px; border-radius: 14px; text-align: center; margin: 20px 0; color: white; }
        .status-ready { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .status-working { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        h3 { margin: 25px 0 15px; color: #333; font-size: 18px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .settings-box { background: #fff3cd; padding: 15px; border-radius: 10px; margin: 20px 0; }
        .settings-box h4 { margin-bottom: 10px; color: #856404; }
    </style>
</head>
<body>
    <div class="brand">SERFA TEKNƒ∞K</div>
    <div class="container">
        <div id="app"></div>
    </div>

    <script>
        var SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzMG-YqtjVNkkRuMD_4UNhLkCdU03eNLTB31fjDI5rdYd_YeTRTbxMtmepf3TpSFTN4/exec';
        var ADMIN_PASSWORD = localStorage.getItem('adminPassword') || '1234';
        
        var APP = {
            workers: [],
            sites: [],
            records: [],
            currentWorker: JSON.parse(localStorage.getItem('currentWorker') || 'null'),
            workStart: JSON.parse(localStorage.getItem('workStart') || 'null'),
            location: null
        };

        function init() {
            getLocation();
            setInterval(getLocation, 30000);
            showHome();
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(pos) { APP.location = { lat: pos.coords.latitude, lng: pos.coords.longitude }; },
                    function() { APP.location = null; },
                    { enableHighAccuracy: true }
                );
            }
        }

        function render(html) {
            document.getElementById('app').innerHTML = html;
        }

        function showLoading() {
            return '<div class="loading"><div class="spinner"></div><p>Y√ºkleniyor...</p></div>';
        }

        async function loadData(sheet) {
            try {
                var res = await fetch(SCRIPT_URL + '?sheet=' + sheet);
                var data = await res.json();
                return data.data || [];
            } catch (e) {
                console.error('Y√ºkleme hatasƒ±:', e);
                return [];
            }
        }

        async function saveData(sheet, values) {
            try {
                var res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ sheet: sheet, values: values })
                });
                var result = await res.json();
                return result.success;
            } catch (e) {
                console.error('Kayƒ±t hatasƒ±:', e);
                alert('‚ö†Ô∏è Veri kaydedilemedi!');
                return false;
            }
        }

        function showHome() {
            var html = '<div class="header"><h1>üèóÔ∏è ≈ûantiye Takip Sistemi</h1><p>Profesyonel ƒ∞n≈üaat Y√∂netimi</p></div>';
            html += '<div class="home-content">';
            html += '<div class="home-icon">üèóÔ∏è</div>';
            html += '<h2>Ho≈ü Geldiniz</h2>';
            html += '<button class="btn btn-manager" onclick="showManagerLogin()">üëî ƒ∞≈üveren / Y√∂netici</button>';
            html += '<button class="btn btn-worker" onclick="showWorkerLogin()">üë∑ ƒ∞≈ü√ßi</button>';
            html += '</div>';
            render(html);
        }

        function showManagerLogin() {
            var html = '<div class="header"><h1>üëî Y√∂netici Giri≈üi</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">‚Üê Geri</button>';
            html += '<div style="text-align: center; padding: 40px 20px;">';
            html += '<div style="font-size: 60px; margin-bottom: 20px;">üîê</div>';
            html += '<h2>≈ûifre Girin</h2>';
            html += '<div class="form-group"><input type="password" id="pass" placeholder="≈ûifre"></div>';
            html += '<button class="btn btn-primary" onclick="checkPass()">Giri≈ü</button>';
            html += '</div></div>';
            render(html);
        }

        function checkPass() {
            if (document.getElementById('pass').value === ADMIN_PASSWORD) {
                showManagerPanel('add');
            } else {
                alert('‚ùå Hatalƒ± ≈üifre!');
            }
        }

        async function showManagerPanel(tab) {
            render('<div class="header"><h1>üëî Y√∂netici Paneli</h1></div><div class="content">' + showLoading() + '</div>');
            
            var workersData = await loadData('workers');
            var sitesData = await loadData('sites');
            var recordsData = await loadData('records');
            
            APP.workers = [];
            APP.sites = [];
            APP.records = [];
            
            for (var i = 1; i < workersData.length; i++) {
                if (workersData[i] && workersData[i][0]) {
                    APP.workers.push({ 
                        id: workersData[i][0], 
                        name: workersData[i][1] || '', 
                        wage: workersData[i][2] || '',
                        password: workersData[i][3] || ''
                    });
                }
            }
            
            for (var i = 1; i < sitesData.length; i++) {
                if (sitesData[i] && sitesData[i][0]) {
                    APP.sites.push({ id: sitesData[i][0], name: sitesData[i][1] || '', addr: sitesData[i][2] || '' });
                }
            }
            
            for (var i = 1; i < recordsData.length; i++) {
                if (recordsData[i] && recordsData[i][0]) {
                    APP.records.push({
                        id: recordsData[i][0],
                        wid: recordsData[i][1] || '',
                        wname: recordsData[i][2] || '',
                        sid: recordsData[i][3] || '',
                        sname: recordsData[i][4] || '',
                        date: recordsData[i][5] || '',
                        hours: recordsData[i][6] || '',
                        cost: recordsData[i][7] || ''
                    });
                }
            }
            
            var html = '<div class="header"><h1>üëî Y√∂netici Paneli</h1></div>';
            html += '<div class="tabs">';
            html += '<button class="tab ' + (tab === 'add' ? 'active' : '') + '" onclick="showManagerPanel(\'add\')">‚ûï Ekle</button>';
            html += '<button class="tab ' + (tab === 'list' ? 'active' : '') + '" onclick="showManagerPanel(\'list\')">üìã Liste</button>';
            html += '<button class="tab ' + (tab === 'report' ? 'active' : '') + '" onclick="showManagerPanel(\'report\')">üìä Rapor</button>';
            html += '<button class="tab ' + (tab === 'settings' ? 'active' : '') + '" onclick="showManagerPanel(\'settings\')">‚öôÔ∏è Ayarlar</button>';
            html += '</div><div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">‚Üê √áƒ±kƒ±≈ü</button>';

            if (tab === 'add') {
                html += '<h3>ƒ∞≈ü√ßi Ekle</h3>';
                html += '<div class="form-group"><label>Ad Soyad</label><input id="wn"></div>';
                html += '<div class="form-group"><label>G√ºnl√ºk √úcret (‚Ç∫)</label><input type="number" id="ww"></div>';
                html += '<div class="form-group"><label>ƒ∞≈ü√ßi ≈ûifresi (4 haneli)</label><input type="text" id="wp" placeholder="√∂rn: 5678" maxlength="4"></div>';
                html += '<button class="btn btn-primary" onclick="addWorker()">ƒ∞≈ü√ßi Ekle</button><hr style="margin: 30px 0;">';
                html += '<h3>≈ûantiye Ekle</h3>';
                html += '<div class="form-group"><label>≈ûantiye Adƒ±</label><input id="sn"></div>';
                html += '<div class="form-group"><label>Adres</label><input id="sa"></div>';
                html += '<button class="btn btn-primary" onclick="addSite()">≈ûantiye Ekle</button>';
            } else if (tab === 'list') {
                html += '<h3>ƒ∞≈ü√ßiler (' + APP.workers.length + ')</h3>';
                if (APP.workers.length === 0) html += '<div class="alert alert-info">Hen√ºz i≈ü√ßi eklenmemi≈ü</div>';
                for (var i = 0; i < APP.workers.length; i++) {
                    html += '<div class="card"><b>' + APP.workers[i].name + '</b><br><small>üí∞ ' + APP.workers[i].wage + '‚Ç∫/g√ºn ‚Ä¢ üîê ≈ûifre: ' + APP.workers[i].password + '</small><br>';
                    html += '<button class="btn btn-delete" onclick="deleteWorker(\'' + APP.workers[i].id + '\')">üóëÔ∏è Sil</button></div>';
                }
                html += '<h3>≈ûantiyeler (' + APP.sites.length + ')</h3>';
                if (APP.sites.length === 0) html += '<div class="alert alert-info">Hen√ºz ≈üantiye eklenmemi≈ü</div>';
                for (var i = 0; i < APP.sites.length; i++) {
                    html += '<div class="card"><b>' + APP.sites[i].name + '</b><br><small>üìç ' + APP.sites[i].addr + '</small><br>';
                    html += '<button class="btn btn-delete" onclick="deleteSite(\'' + APP.sites[i].id + '\')">üóëÔ∏è Sil</button></div>';
                }
                html += '<h3>Kayƒ±tlar (' + APP.records.length + ')</h3>';
                if (APP.records.length === 0) html += '<div class="alert alert-info">Hen√ºz kayƒ±t olu≈üturulmamƒ±≈ü</div>';
                for (var i = APP.records.length - 1; i >= 0; i--) {
                    var r = APP.records[i];
                    html += '<div class="card"><b>' + r.wname + ' - ' + r.cost + '‚Ç∫</b><br><small>' + r.sname + ' ‚Ä¢ ' + r.date + ' ‚Ä¢ ' + r.hours + ' saat</small></div>';
                }
            } else if (tab === 'report') {
                var totalC = 0, totalH = 0;
                for (var i = 0; i < APP.records.length; i++) {
                    totalC += parseFloat(APP.records[i].cost || 0);
                    totalH += parseFloat(APP.records[i].hours || 0);
                }
                html += '<button class="btn btn-excel" onclick="exportToExcel()">üìä Excel ƒ∞ndir</button>';
                html += '<div class="stats">';
                html += '<div class="stat-box"><div class="stat-value">' + totalH.toFixed(1) + '</div><div class="stat-label">TOPLAM SAAT</div></div>';
                html += '<div class="stat-box"><div class="stat-value">' + totalC.toFixed(0) + '‚Ç∫</div><div class="stat-label">TOPLAM MALƒ∞YET</div></div>';
                html += '</div>';
            } else if (tab === 'settings') {
                html += '<div class="settings-box">';
                html += '<h4>‚öôÔ∏è Y√∂netici ≈ûifresi Deƒüi≈ütir</h4>';
                html += '<div class="form-group"><label>Mevcut ≈ûifre: <b>' + ADMIN_PASSWORD + '</b></label></div>';
                html += '<div class="form-group"><label>Yeni ≈ûifre</label><input type="text" id="newpass"></div>';
                html += '<button class="btn btn-primary" onclick="changeAdminPassword()">≈ûifreyi Deƒüi≈ütir</button>';
                html += '</div>';
            }
            html += '</div>';
            render(html);
        }

        function changeAdminPassword() {
            var newPass = document.getElementById('newpass').value.trim();
            if (!newPass || newPass.length < 4) {
                alert('‚ùå ≈ûifre en az 4 karakter olmalƒ±!');
                return;
            }
            ADMIN_PASSWORD = newPass;
            localStorage.setItem('adminPassword', ADMIN_PASSWORD);
            alert('‚úÖ Y√∂netici ≈üifresi deƒüi≈ütirildi: ' + ADMIN_PASSWORD);
            showManagerPanel('settings');
        }

        async function addWorker() {
            var n = document.getElementById('wn').value.trim();
            var w = document.getElementById('ww').value.trim();
            var p = document.getElementById('wp').value.trim();
            if (!n || !w || !p) { alert('‚ùå T√ºm alanlarƒ± doldurun!'); return; }
            if (p.length !== 4) { alert('‚ùå ≈ûifre 4 haneli olmalƒ±!'); return; }
            
            var id = Date.now().toString();
            var success = await saveData('workers', [[id, n, w, p]]);
            
            if (success) {
                alert('‚úÖ ƒ∞≈ü√ßi eklendi!\nAd: ' + n + '\n≈ûifre: ' + p);
                showManagerPanel('add');
            }
        }

        async function addSite() {
            var n = document.getElementById('sn').value.trim();
            var a = document.getElementById('sa').value.trim();
            if (!n || !a) { alert('‚ùå Eksik bilgi!'); return; }
            
            var id = Date.now().toString();
            var success = await saveData('sites', [[id, n, a]]);
            
            if (success) {
                alert('‚úÖ ≈ûantiye eklendi!');
                showManagerPanel('add');
            }
        }

        async function deleteWorker(id) {
            if (!confirm('Bu i≈ü√ßiyi silmek istediƒüinize emin misiniz?')) return;
            alert('‚ö†Ô∏è Silme √∂zelliƒüi Google Sheets\'te manuel yapƒ±lmalƒ±. ID: ' + id);
        }

        async function deleteSite(id) {
            if (!confirm('Bu ≈üantiyeyi silmek istediƒüinize emin misiniz?')) return;
            alert('‚ö†Ô∏è Silme √∂zelliƒüi Google Sheets\'te manuel yapƒ±lmalƒ±. ID: ' + id);
        }

        function exportToExcel() {
            var csv = 'ƒ∞≈ü√ßi,≈ûantiye,Tarih,Saat,Maliyet (‚Ç∫)\n';
            for (var i = 0; i < APP.records.length; i++) {
                var r = APP.records[i];
                csv += r.wname + ',' + r.sname + ',' + r.date + ',' + r.hours + ',' + r.cost + '\n';
            }
            var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'serfa-rapor-' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            alert('‚úÖ Excel dosyasƒ± indiriliyor!');
        }

        async function showWorkerLogin() {
            render('<div class="header worker"><h1>üë∑ ƒ∞≈ü√ßi Giri≈üi</h1></div><div class="content">' + showLoading() + '</div>');
            
            var workersData = await loadData('workers');
            APP.workers = [];
            
            for (var i = 1; i < workersData.length; i++) {
                if (workersData[i] && workersData[i][0]) {
                    APP.workers.push({ 
                        id: workersData[i][0], 
                        name: workersData[i][1] || '', 
                        wage: workersData[i][2] || '',
                        password: workersData[i][3] || ''
                    });
                }
            }
            
            if (APP.workers.length === 0) { 
                alert('‚ö†Ô∏è Hen√ºz i≈ü√ßi kaydƒ± yok!'); 
                showHome(); 
                return; 
            }
            
            var html = '<div class="header worker"><h1>üë∑ ƒ∞≈ü√ßi Giri≈üi</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="showHome()">‚Üê Geri</button>';
            html += '<div style="text-align: center; padding: 40px 20px;">';
            html += '<div style="font-size: 60px; margin-bottom: 20px;">üë∑</div>';
            html += '<h2>ƒ∞sminizi Se√ßin</h2>';
            html += '<div class="form-group"><select id="ws"><option value="">Se√ßin...</option>';
            for (var i = 0; i < APP.workers.length; i++) {
                html += '<option value="' + i + '">' + APP.workers[i].name + '</option>';
            }
            html += '</select></div>';
            html += '<div class="form-group"><label>≈ûifreniz (4 haneli)</label><input type="password" id="wpass" maxlength="4" placeholder="****"></div>';
            html += '<button class="btn btn-success" onclick="loginWorker()">Giri≈ü</button>';
            html += '</div></div>';
            render(html);
        }

        function loginWorker() {
            var idx = parseInt(document.getElementById('ws').value);
            var pass = document.getElementById('wpass').value.trim();
            
            if (isNaN(idx) || idx < 0) { 
                alert('‚ùå ƒ∞≈ü√ßi se√ßin!'); 
                return; 
            }
            
            if (!pass) {
                alert('‚ùå ≈ûifre girin!');
                return;
            }
            
            APP.currentWorker = APP.workers[idx];
            
            console.log('Girilen ≈üifre:', pass);
            console.log('Beklenen ≈üifre:', APP.currentWorker.password);
            console.log('≈ûifre tipi:', typeof APP.currentWorker.password, typeof pass);
            
            if (String(APP.currentWorker.password).trim() !== String(pass).trim()) {
                alert('‚ùå Hatalƒ± ≈üifre!\nGirilen: ' + pass + '\nBeklenen: ' + APP.currentWorker.password);
                return;
            }
            
            localStorage.setItem('currentWorker', JSON.stringify(APP.currentWorker));
            showWorkerPanel();
        }

        async function showWorkerPanel() {
            render('<div class="header worker"><h1>üë∑ ' + APP.currentWorker.name + '</h1></div><div class="content">' + showLoading() + '</div>');
            
            var recordsData = await loadData('records');
            var sitesData = await loadData('sites');
            
            APP.records = [];
            APP.sites = [];
            
            for (var i = 1; i < recordsData.length; i++) {
                if (recordsData[i] && recordsData[i][0]) {
                    APP.records.push({
                        id: recordsData[i][0],
                        wid: recordsData[i][1] || '',
                        wname: recordsData[i][2] || '',
                        sid: recordsData[i][3] || '',
                        sname: recordsData[i][4] || '',
                        date: recordsData[i][5] || '',
                        hours: recordsData[i][6] || '',
                        cost: recordsData[i][7] || ''
                    });
                }
            }
            
            for (var i = 1; i < sitesData.length; i++) {
                if (sitesData[i] && sitesData[i][0]) {
                    APP.sites.push({ id: sitesData[i][0], name: sitesData[i][1] || '', addr: sitesData[i][2] || '' });
                }
            }
            
            var myRecs = [];
            for (var i = 0; i < APP.records.length; i++) {
                if (APP.records[i].wid === APP.currentWorker.id) {
                    myRecs.push(APP.records[i]);
                }
            }

            var html = '<div class="header worker"><h1>üë∑ ' + APP.currentWorker.name + '</h1></div>';
            html += '<div class="content">';
            html += '<button class="btn btn-back" onclick="logoutWorker()">üö™ √áƒ±kƒ±≈ü</button>';

            if (!APP.workStart) {
                if (!APP.location) {
                    html += '<div class="alert alert-danger">‚ö†Ô∏è GPS KAPALI!</div>';
                    html += '<button class="btn btn-refresh" onclick="getLocation(); setTimeout(showWorkerPanel, 1000);">üîÑ GPS Yenile</button>';
                } else {
                    html += '<div class="location-badge">‚úÖ GPS Aktif</div>';
                }
                
                html += '<div class="status-card status-ready"><div style="font-size: 60px; margin-bottom: 15px;">üü¢</div><h2>Hazƒ±r</h2><p>√áalƒ±≈ümaya ba≈ülamak i√ßin ≈üantiye se√ßin</p></div>';
                
                if (APP.sites.length === 0) {
                    html += '<div class="alert alert-warning">‚ö†Ô∏è Hen√ºz ≈üantiye eklenmemi≈ü!</div>';
                } else {
                    html += '<div class="form-group"><label>≈ûantiye Se√ß</label><select id="wss"><option value="">Se√ßin...</option>';
                    for (var i = 0; i < APP.sites.length; i++) {
                        html += '<option value="' + i + '">' + APP.sites[i].name + '</option>';
                    }
                    html += '</select></div>';
                    html += '<button class="btn btn-success" onclick="startWork()" ' + (!APP.location ? 'disabled' : '') + '>üöÄ √áalƒ±≈ümaya Ba≈üla</button>';
                }
                
                html += '<h3>Y√ºklediƒüim Kayƒ±tlar (' + myRecs.length + ')</h3>';
                if (myRecs.length === 0) html += '<div class="alert alert-info">Hen√ºz kayƒ±t yok</div>';
                for (var i = myRecs.length - 1; i >= 0; i--) {
                    var r = myRecs[i];
                    html += '<div class="card"><b>' + r.sname + '</b><br><small>' + r.date + ' ‚Ä¢ ' + r.hours + ' saat</small></div>';
                }
            } else {
                html += '<div class="alert alert-success">‚ö° √áalƒ±≈üma devam ediyor...</div>';
                html += '<div class="status-card status-working"><div style="font-size: 60px; margin-bottom: 15px;">‚ö°</div><h2>' + APP.workStart.sname + '</h2><p>Ba≈ülangƒ±√ß: ' + new Date(APP.workStart.time).toLocaleTimeString('tr-TR') + '</p></div>';
                html += '<div class="form-group"><label>Fotoƒüraf (Zorunlu)</label><input type="file" id="wp" accept="image/*" capture="environment" style="width:100%;padding:12px;border:2px dashed #2ecc71;border-radius:10px;"></div>';
                html += '<button class="btn btn-danger" onclick="endWork()">‚èπÔ∏è Bitir ve Kaydet</button>';
            }
            html += '</div>';
            render(html);
        }

        function startWork() {
            if (!APP.location) { 
                alert('‚ùå GPS aktif deƒüil! GPS\'i a√ßƒ±n ve "GPS Yenile" butonuna basƒ±n.'); 
                return; 
            }
            
            var idx = parseInt(document.getElementById('wss').value);
            
            if (isNaN(idx) || idx < 0) { 
                alert('‚ùå ≈ûantiye se√ßin!'); 
                return; 
            }
            
            var site = APP.sites[idx];
            
            APP.workStart = { 
                wid: APP.currentWorker.id, 
                wname: APP.currentWorker.name, 
                sid: site.id, 
                sname: site.name, 
                time: Date.now()
            };
            
            localStorage.setItem('workStart', JSON.stringify(APP.workStart));
            alert('‚úÖ √áalƒ±≈üma ba≈üladƒ±!');
            showWorkerPanel();
        }

        async function endWork() {
            if (!APP.location) { alert('‚ö†Ô∏è GPS yok!'); return; }
            var pf = document.getElementById('wp').files[0];
            if (!pf) { alert('‚ùå Fotoƒüraf gerekli!'); return; }
            
            var reader = new FileReader();
            reader.onload = async function(e) {
                var h = ((Date.now() - APP.workStart.time) / 3600000).toFixed(2);
                var c = ((parseFloat(APP.currentWorker.wage) / 8) * parseFloat(h)).toFixed(2);
                var id = Date.now().toString();
                var date = new Date().toISOString().split('T')[0];
                
                var success = await saveData('records', [[
                    id,
                    APP.workStart.wid,
                    APP.workStart.wname,
                    APP.workStart.sid,
                    APP.workStart.sname,
                    date,
                    h,
                    c,
                    'PHOTO_' + id
                ]]);
                
                if (success) {
                    APP.workStart = null;
                    localStorage.removeItem('workStart');
                    alert('‚úÖ Tamamlandƒ±! ' + h + ' saat kaydedildi.');
                    showWorkerPanel();
                }
            };
            reader.readAsDataURL(pf);
        }

        function logoutWorker() {
            if (APP.workStart && !confirm('‚ö†Ô∏è √áalƒ±≈üma devam ediyor! √áƒ±karsanƒ±z kayƒ±t silinecek. Emin misiniz?')) return;
            APP.currentWorker = null;
            APP.workStart = null;
            localStorage.removeItem('currentWorker');
            localStorage.removeItem('workStart');
            showHome();
        }

        init();
    </script>
</body>
</html>
